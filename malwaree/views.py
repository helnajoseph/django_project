from django.http import HttpResponse
from django.shortcuts import render
from django.shortcuts import redirect
# FILE UPLOAD AND VIEW
from  django.core.files.storage import FileSystemStorage
# SESSION
from django.conf import settings
from .models import *
from django.db.models import F
import os
from tensorflow.keras import backend as k
from ML import test1



def home(request):
 0   return render(request,'index.html')

def index(request):
    return render(request,'index.html')

def register(request):
    return render(request,'register.html')

def addregister(request):
    if request.method=="POST":
        a=request.POST.get('name') 
        b=request.POST.get('email')
        c=request.POST.get('password')
        d=request.POST.get('phone')   
        ins=regtable(name=a,email=b,password=c,phone=d)
        ins.save()
    return render(request,'register.html')

def login(request):
    return render(request,'login.html')

def addlogin(request):
    email=request.POST.get('email')
    password=request.POST.get('password')
    if email=='admin@gmail.com'and password=='admin':
       request.session['admin@gmail.com']='admin@gmail.com'
       request.session['admin']='admin'
       ins=regtable.objects.all()
       return render(request,'index.html')

    elif regtable.objects.filter(email=email,password=password).exists():
        userdetails=regtable.objects.get(email=email,password=password)
        if userdetails.email==request.POST['email']:
            request.session['userid']=userdetails.id
            request.session['username']=userdetails.name 
            return render(request,'index.html')  
    else:
         return render(request,'login.html')

def logout(request):
    session_keys=list(request.session.keys())   
    for key in session_keys:
            del request.session[key] 
    return redirect(index)

def viewuser(request):
    user=regtable.objects.all()
    return render(request,'viewuser.html',{'result':user}) 

def upload(request):
    return render(request,'upload.html')
    
def addupload(request):
    if request.method == "POST":
        myfile=request.FILES['file'] 
        fs=FileSystemStorage()
        filename=fs.save(myfile.name,myfile)
        try:
            os.remove(os.path.join(settings.MEDIA_ROOT,'input/test/test.csv'))
        except:
            pass
        fs=FileSystemStorage(location=os.path.join(settings.MEDIA_ROOT,'input/test/'))  
        fs.save("test.csv", myfile) 
        fs=FileSystemStorage()
        fs.save(myfile.name,myfile) 
        k.clear_session()

        result=test1.predict()

        ins=uploadtable(images=filename,user_id=request.session['userid'],result=result)
        ins.save()
    return render(request,'upload.html',{'result':result})

def viewupload(request):
    ups=uploadtable.objects.all()
    us=regtable.objects.all()
    for i in ups:
        for j in us:
            if str(i.user_id) == str(j.id):
                i.user_id = j.name
    return render(request,'viewupload.html',{'result':ups})    

def viewupload_user(request):
    ups=uploadtable.objects.filter(user_id= request.session['userid'])
    return render(request,'viewupload_user.html',{'result':ups}) 

